# Securing Apache Kafka Broker with Zookeeper

This guide will help you configure **end-to-end security** for an **Apache Kafka** broker connected through **Zookeeper**.

You will implement **TLS (Transport Layer Security)** for encryption, **SASL/SCRAM (Simple Authentication and Security Layer / Salted Challenge Response Authentication Mechanism)** for authentication, and **ACLs (Access Control Lists)** for authorization.

## Overview of Security Layers

| Layer                                      | Purpose                                                                 | Technology Used                |
| ------------------------------------------ | ----------------------------------------------------------------------- | ------------------------------ |
| **Encryption (Confidentiality)**           | Protects data in transit between Kafka clients, brokers, and Zookeeper. | TLS (Transport Layer Security) |
| **Authentication (Identity Verification)** | Ensures only authorized users and brokers connect.                      | SASL/SCRAM-SHA-512             |
| **Authorization (Access Control)**         | Restricts who can publish or consume topics.                            | Kafka ACLs                     |

## 1. Prerequisites

You need:

- A working **Kafka + Zookeeper** setup (single or multi-node).
- `openssl` installed on your system.
- Kafka command-line tools (`kafka-server-start.sh`, `kafka-configs.sh`, `kafka-acls.sh`, etc.).
- Root or admin privileges on the broker machine.
- The credentials:

  - Username: `admin`
  - Password: `Welcome#123`

## 2. Create TLS Certificates Using OpenSSL

You will create a simple **Certificate Authority (CA)** and issue a certificate for the Kafka broker.

### Step 1: Create a CA Certificate and Key

```bash
mkdir ~/kafka-security
cd ~/kafka-security

# Create a private key for the CA
openssl genrsa -out ca.key 4096

# Create a self-signed CA certificate valid for 10 years
openssl req -x509 -new -nodes -key ca.key -sha256 -days 3650 -out ca.crt \
  -subj "/CN=Kafka-CA"
```

### Step 2: Create a Broker Key and Certificate Signing Request (CSR)

```bash
# Generate private key for the broker
openssl genrsa -out broker.key 2048

# Generate a CSR for the broker
openssl req -new -key broker.key -out broker.csr \
  -subj "/CN=broker1.example.com"
```

### Step 3: Sign the Broker Certificate Using the CA

```bash
openssl x509 -req -in broker.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out broker.crt -days 365 -sha256
```

Now you have:

```
ca.crt      -> CA certificate
ca.key      -> CA private key
broker.crt  -> Broker certificate
broker.key  -> Broker private key
```

## 3. Configure TLS in Kafka Broker (server.properties)

Edit your `config/server.properties` file:

```properties
# Broker identity
broker.id=1

# Zookeeper connection (not secured for now)
zookeeper.connect=localhost:2181

# Listeners (use SSL for clients)
listeners=SSL://:9093
advertised.listeners=SSL://broker1.example.com:9093
security.inter.broker.protocol=SSL

# SSL configuration (using OpenSSL-generated certs)
ssl.keystore.type=PEM
ssl.keystore.key=/home/kafka-security/broker.key
ssl.keystore.certificate.chain=/home/kafka-security/broker.crt
ssl.truststore.type=PEM
ssl.truststore.certificates=/home/kafka-security/ca.crt

# Client authentication not required (TLS only)
ssl.client.auth=none
```

Restart Kafka after saving:

```bash
bin/kafka-server-stop.sh
bin/kafka-server-start.sh -daemon config/server.properties
```

## 4. Enable Authentication with SASL/SCRAM-SHA-512

Kafka supports multiple SASL mechanisms (Simple Authentication and Security Layer).
Here we use **SCRAM-SHA-512 (Salted Challenge Response Authentication Mechanism using SHA-512)**.

### Step 1: Add SASL Listener to `server.properties`

```properties
listeners=SASL_SSL://:9093
advertised.listeners=SASL_SSL://broker1.example.com:9093
security.inter.broker.protocol=SASL_SSL

sasl.enabled.mechanisms=SCRAM-SHA-512
```

### Step 2: Create User Credentials in Zookeeper

Kafka stores SCRAM credentials in **Zookeeper** for Kafka + Zookeeper deployments.

```bash
bin/kafka-configs.sh --zookeeper localhost:2181 \
  --alter --add-config 'SCRAM-SHA-512=[password=Welcome#123]' \
  --entity-type users --entity-name admin
```

### Step 3: Restart the Broker

```bash
bin/kafka-server-stop.sh
bin/kafka-server-start.sh -daemon config/server.properties
```

## 5. Configure Client for SASL_SSL Connection

Create a file named `client.properties`:

```properties
security.protocol=SASL_SSL
sasl.mechanism=SCRAM-SHA-512
sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required \
    username="admin" password="Welcome#123";
ssl.truststore.type=PEM
ssl.truststore.certificates=/home/kafka-security/ca.crt
```

Now test the connection using Kafka console tools.

### Test Producer

```bash
bin/kafka-console-producer.sh --broker-list broker1.example.com:9093 \
  --topic secure-test --producer.config client.properties
```

### Test Consumer

```bash
bin/kafka-console-consumer.sh --bootstrap-server broker1.example.com:9093 \
  --topic secure-test --consumer.config client.properties --from-beginning
```

If successful, both encryption (TLS) and authentication (SCRAM) are working.

## 6. Enable Authorization (ACLs)

### Step 1: Enable ACL Authorizer in `server.properties`

```properties
authorizer.class.name=kafka.security.authorizer.AclAuthorizer
allow.everyone.if.no.acl.found=false
```

### Step 2: Create ACLs for the `admin` User

```bash
# Allow 'admin' to write to topic 'secure-test'
bin/kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 \
  --add --allow-principal User:admin --operation Write --topic secure-test

# Allow 'admin' to read from the same topic
bin/kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 \
  --add --allow-principal User:admin --operation Read --topic secure-test
```

### Step 3: Verify ACLs

```bash
bin/kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 --list
```

Only `admin` will now be able to produce and consume from `secure-test`.

## 7. Verify and Troubleshoot

### Verify TLS

```bash
openssl s_client -connect broker1.example.com:9093 -showcerts
```

You should see the broker certificate and a successful handshake.

### Common Issues and Fixes

| Issue                        | Possible Cause                   | Fix                                                                |
| ---------------------------- | -------------------------------- | ------------------------------------------------------------------ |
| `SASL authentication failed` | Incorrect username or password   | Verify username `admin` and password `Welcome#123`                 |
| `SSLHandshakeException`      | Certificate or hostname mismatch | Ensure CN (Common Name) in certificate matches advertised listener |
| `Topic authorization failed` | Missing ACLs                     | Verify ACLs with `kafka-acls.sh --list`                            |

## 8. Optional â€” Secure Zookeeper (Advanced)

Zookeeper can also be secured with **TLS** and **SASL**.
For now, we focus on Kafka broker-client communication.
In production, you should enable:

```properties
zookeeper.ssl.client.enable=true
zookeeper.ssl.keyStore.location=...
zookeeper.ssl.trustStore.location=...
```

and configure a JAAS file for Zookeeper authentication.

## 9. Security Verification Checklist

| Layer                           | Configuration                   | Verified By                     |
| ------------------------------- | ------------------------------- | ------------------------------- |
| **Encryption (TLS)**            | Broker certificate signed by CA | `openssl s_client`              |
| **Authentication (SASL/SCRAM)** | `admin / Welcome#123`           | Successful produce/consume test |
| **Authorization (ACL)**         | ACLs for topic `secure-test`    | `kafka-acls.sh --list`          |

## 10. Summary

You have now secured your Kafka broker as follows:

- **Encryption:** Enabled via TLS using OpenSSL certificates.
- **Authentication:** Configured using SASL/SCRAM-SHA-512 with username `admin` and password `Welcome#123`.
- **Authorization:** Implemented using ACLs for fine-grained access control.

## 11. Clean-Up Commands

To remove user credentials:

```bash
bin/kafka-configs.sh --zookeeper localhost:2181 \
  --alter --delete-config 'SCRAM-SHA-512' \
  --entity-type users --entity-name admin
```

To remove ACLs:

```bash
bin/kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 \
  --remove --principal User:admin
```

## 12. Key Terms (For Students)

| Term      | Full Form                                          | Description                                                             |
| --------- | -------------------------------------------------- | ----------------------------------------------------------------------- |
| **TLS**   | Transport Layer Security                           | Protocol that encrypts communication between Kafka brokers and clients. |
| **SASL**  | Simple Authentication and Security Layer           | Framework for authentication mechanisms.                                |
| **SCRAM** | Salted Challenge Response Authentication Mechanism | Authentication method that securely stores and verifies passwords.      |
| **ACL**   | Access Control List                                | Defines permissions for users on Kafka resources.                       |
| **CA**    | Certificate Authority                              | Entity that issues and signs digital certificates.                      |
| **CSR**   | Certificate Signing Request                        | A request sent to a CA to obtain a signed certificate.                  |
